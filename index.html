<!doctype html>



  


<html class="theme-next muse use-motion" lang="zh-Hans">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>



<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />















  
  
  <link href="/lib/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css" />




  
  
  
  

  
    
    
  

  

  

  

  

  
    
    
    <link href="//fonts.googleapis.com/css?family=Lato:300,300italic,400,400italic,700,700italic&subset=latin,latin-ext" rel="stylesheet" type="text/css">
  






<link href="/lib/font-awesome/css/font-awesome.min.css?v=4.6.2" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=5.1.0" rel="stylesheet" type="text/css" />


  <meta name="keywords" content="Hexo, NexT" />





  <link rel="alternate" href="/atom.xml" title="IFchanged" type="application/atom+xml" />




  <link rel="shortcut icon" type="image/x-icon" href="/favicon.ico?v=5.1.0" />






<meta property="og:type" content="website">
<meta property="og:title" content="IFchanged">
<meta property="og:url" content="http://ifchanged.io/index.html">
<meta property="og:site_name" content="IFchanged">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="IFchanged">



<script type="text/javascript" id="hexo.configurations">
  var NexT = window.NexT || {};
  var CONFIG = {
    root: '/',
    scheme: 'Muse',
    sidebar: {"position":"left","display":"post","offset":12,"offset_float":0,"b2t":false,"scrollpercent":false},
    fancybox: true,
    motion: true,
    duoshuo: {
      userId: '0',
      author: '博主'
    },
    algolia: {
      applicationID: '',
      apiKey: '',
      indexName: '',
      hits: {"per_page":10},
      labels: {"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}
    }
  };
</script>



  <link rel="canonical" href="http://ifchanged.io/"/>





  <title> IFchanged </title>
</head>

<body itemscope itemtype="http://schema.org/WebPage" lang="zh-Hans">

  




<script>
  (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
            (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
          m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
  })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');
  ga('create', 'UA-99172222-1', 'auto');
  ga('send', 'pageview');
</script>











  
  
    
  

  <div class="container sidebar-position-left 
   page-home 
 ">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-wrapper">
  <div class="site-meta ">
    

    <div class="custom-logo-site-title">
      <a href="/"  class="brand" rel="start">
        <span class="logo-line-before"><i></i></span>
        <span class="site-title">IFchanged</span>
        <span class="logo-line-after"><i></i></span>
      </a>
    </div>
      
        <p class="site-subtitle"></p>
      
  </div>

  <div class="site-nav-toggle">
    <button>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
      <span class="btn-bar"></span>
    </button>
  </div>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br />
            
            首页
          </a>
        </li>
      
        
        <li class="menu-item menu-item-categories">
          <a href="/categories" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-th"></i> <br />
            
            分类
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br />
            
            归档
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-tags"></i> <br />
            
            标签
          </a>
        </li>
      
        
        <li class="menu-item menu-item-sitemap">
          <a href="/sitemap.xml" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-sitemap"></i> <br />
            
            站点地图
          </a>
        </li>
      

      
    </ul>
  

  
</nav>



 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            
  <section id="posts" class="posts-expand">
    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <link itemprop="mainEntityOfPage" href="http://ifchanged.io/2017/Kubernetes笔记/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="zeroten">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="IFchanged">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2017/Kubernetes笔记/" itemprop="url">
                  Kubernetes笔记
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2017-09-09T00:33:43+08:00">
                2017-09-09
              </time>
            

            

            
          </span>

          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2017/Kubernetes笔记/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count disqus-comment-count"
                        data-disqus-identifier="2017/Kubernetes笔记/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          

          

          

          

        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="1-简介"><a href="#1-简介" class="headerlink" title="1. 简介"></a>1. 简介</h2><p>Kubernetes一个用于容器集群的自动化部署、扩容以及运维的开源平台。</p>
<h3 id="1-1-基本概念"><a href="#1-1-基本概念" class="headerlink" title="1.1 基本概念"></a>1.1 基本概念</h3><ul>
<li>master：主节点，负责k8s调度，不应部署容器</li>
<li>node：master之外的主机节点</li>
<li>pod：一组容器的集合，在一个pod只部署一个容器时，可基本等价于容器实例</li>
<li>deployment：一个容器、编排部署集合</li>
<li>service：一个服务，简单理解deployment通过service暴露在网络中</li>
</ul>
<p>所以，用deployment管理一组pod，用service暴露deployment。</p>
<ul>
<li>Pod: 若干 container 组成的一个功能单元，共享相同的 IP / Namesapce / Volume</li>
</ul>
<h3 id="1-2-基本架构"><a href="#1-2-基本架构" class="headerlink" title="1.2 基本架构"></a>1.2 基本架构</h3><ul>
<li>Single Master: <ul>
<li>kube-apiserver - 响应 REST 请求，更新 etcd 信息</li>
<li>kube-scheduler - Pods 调度</li>
<li>kube-controller-manager - 所有其它控制功能</li>
</ul>
</li>
<li>Nodes: <ul>
<li>kube-proxy - 网络代理和负载均衡器</li>
<li>kubelet - 与 master 交互，管理 Pod</li>
</ul>
</li>
</ul>
<p>Internet –&gt; kube-proxy –&gt; Pods</p>
<p>注：1.2版之前是由运行在 userspace 的 kube-proxy 分发请求，1.2 版 kube-proxy 监视服务变化，生成相应 iptables rules</p>
<h3 id="1-3-部署模型"><a href="#1-3-部署模型" class="headerlink" title="1.3 部署模型"></a>1.3 部署模型</h3><ul>
<li>Deployment/Replication controller - Pod 池，确保一个 Pod 有一定份数运行，可用作负载均衡和水平扩展</li>
<li>Service - 定义了一组 Pods 的逻辑集合和访问这个集合的策略，提供一个 Micro Service</li>
<li>Endpoints - 一个 API，更新 Service 中的 Pods 集合</li>
</ul>
<h2 id="2-k8s技术介绍"><a href="#2-k8s技术介绍" class="headerlink" title="2. k8s技术介绍"></a>2. k8s技术介绍</h2><h3 id="2-1-网络"><a href="#2-1-网络" class="headerlink" title="2.1 网络"></a>2.1 网络</h3><p>使用flannel组件建立容器间网络，也是运维管理维护最麻烦的地方，因此：</p>
<ul>
<li>有三个网络，只需要运维了解，业务开发时不需要关心：<ul>
<li>Cluster Network：虚拟局域网，pod所处的实际网络，pod获得Cluster IP。Cluster Network内部互通，内部pod可以访问公网、物理局域网</li>
<li>物理局域网：外部主机所处的物流局域网</li>
<li>公网</li>
</ul>
</li>
<li>容器继承Node的DNS配置，不继承hosts</li>
<li>pod访问外部时，通过所在Node的网络</li>
<li>只能在Master通过NodePort，把service的端口和物理机连接，把service暴露给公网，这就造成Master的网络压力较大</li>
</ul>
<h3 id="2-3-服务发现"><a href="#2-3-服务发现" class="headerlink" title="2.3 服务发现"></a>2.3 服务发现</h3><p>k8s提供两种发现服务的方式，环境变量和DNS。由于数据库类资源通常使用外部资源，所以有用的是DNS自动给每个service自动注册name，由此可大大简化api-gateway的配置管理工作。</p>
<h4 id="2-3-1-api-gateway"><a href="#2-3-1-api-gateway" class="headerlink" title="2.3.1 api-gateway"></a>2.3.1 api-gateway</h4><p>由于当前网络模式不支持使用宿主机的hosts，且k8s有访问发现机制，所以，</p>
<ol>
<li>gateway地址使用<strong>api-gateway</strong>，免去自建DNS开销。</li>
<li>app地址使用k8s提供的Internal endpoints，即app:port形式，统一使用80端口，则简化为app</li>
<li>app统一使用HTTP协议提供服务<br>例子：<figure class="highlight nginx"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="attribute">location</span> /xxx/ &#123;</div><div class="line">    <span class="attribute">rewrite</span><span class="regexp"> ^/xxx/(.*)</span> /<span class="variable">$1</span> <span class="literal">break</span>;</div><div class="line">    <span class="attribute">proxy_pass</span> xxx;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
</li>
</ol>
<p>需要说明的是，api-gateway和app都应该存在于cluster network内。对于cluster network外的api service，Nginx规则按照老形式配置IP:Port形式；对于cluster network外的需要访问api-gateway的app，则访问外部Nginx，外部Nginx通过NodePort反向代理把请求发送给内部Nginx。</p>
<h3 id="2-4-负载均衡"><a href="#2-4-负载均衡" class="headerlink" title="2.4 负载均衡"></a>2.4 负载均衡</h3><p>请求是首先访问service，然后service根据设置的策略访问pod。简单负载均衡模式和负载均衡器模式可以无缝切换。</p>
<h4 id="2-4-1-简单负载均衡"><a href="#2-4-1-简单负载均衡" class="headerlink" title="2.4.1 简单负载均衡"></a>2.4.1 简单负载均衡</h4><p>在service不使用LoadBalancer模式时，，service以<strong>随机</strong>的方式选择pod。</p>
<p>注：service的实现基于kube-proxy，kube-proxy有两种模式。<strong>userspace</strong>会<strong>循环</strong>选择pod，<strong>iptables</strong>模式会<strong>随机</strong>选择pod，<strong>iptables</strong>是默认模式且性能更好。</p>
<h4 id="2-4-2-使用阿里云SLB负载均衡"><a href="#2-4-2-使用阿里云SLB负载均衡" class="headerlink" title="2.4.2 使用阿里云SLB负载均衡"></a>2.4.2 使用阿里云SLB负载均衡</h4><p>可以直接使用阿里云负载均衡服务<a href="https://intl.aliyun.com/zh/product/server-load-balancer" target="_blank" rel="external">https://intl.aliyun.com/zh/product/server-load-balancer</a>。<code>kubectl expose deployment nginx --port=80 --target-port=80 --type=LoadBalancer</code> 即可。具</p>
<h3 id="2-5-容器调度"><a href="#2-5-容器调度" class="headerlink" title="2.5 容器调度"></a>2.5 容器调度</h3><h4 id="2-5-1-扩容和缩容"><a href="#2-5-1-扩容和缩容" class="headerlink" title="2.5.1 扩容和缩容"></a>2.5.1 扩容和缩容</h4><p>只需要修改deployment配置文件中的spec.replicas参数，k8s会立刻执行调度。</p>
<h4 id="2-5-2-自动调度"><a href="#2-5-2-自动调度" class="headerlink" title="2.5.2 自动调度"></a>2.5.2 自动调度</h4><ul>
<li>k8s会根据Node负载情况分配pod</li>
<li>当有Node不可用时，k8s会自动把pod调度到可用Node</li>
<li>当有docker 容器被关闭时，k8s会根据deploy根据spec.replicas，保证有正确数量的容器在运行</li>
</ul>
<h4 id="2-5-3-pod健康检查"><a href="#2-5-3-pod健康检查" class="headerlink" title="2.5.3 pod健康检查"></a>2.5.3 pod健康检查</h4><p>k8s提供探针对容器进行检测，可以后续开发</p>
<h4 id="2-5-4-自动扩容"><a href="#2-5-4-自动扩容" class="headerlink" title="2.5.4 自动扩容"></a>2.5.4 自动扩容</h4><p>K8s提供<strong>HorizontalPodAutoscaler</strong>实现自动扩容，即根据性能指标自动增加pod的数量，但目前性能指标只支持CPU使用率。</p>
<h2 id="3-k8s的使用"><a href="#3-k8s的使用" class="headerlink" title="3. k8s的使用"></a>3. k8s的使用</h2><h3 id="3-1-更新容器"><a href="#3-1-更新容器" class="headerlink" title="3.1 更新容器"></a>3.1 更新容器</h3><p>可以使用Jenkins调度api或者kubectl</p>
<h4 id="3-1-1-滚动升级"><a href="#3-1-1-滚动升级" class="headerlink" title="3.1.1 滚动升级"></a>3.1.1 滚动升级</h4><p>k8s支持滚动升级，升级过程中，pod逐个替换，直到替换完成，在此过程中旧Pod依然会被使用。可设置minReadySeconds表示启动容器后等待程序启动的时间。</p>
<p>只有更新PodTemplateSpec时才会触发滚动升级，如果镜像使用latest tag，则需要使用<code>kubectl patch deployment &lt;name&gt; -p &quot;{\&quot;spec\&quot;:{\&quot;template\&quot;:{\&quot;metadata\&quot;:{\&quot;labels\&quot;:{\&quot;date\&quot;‌​:\&quot;$(date +%s)\&quot;}}}}}&quot;</code>。</p>
<h4 id="3-1-2-配置更新"><a href="#3-1-2-配置更新" class="headerlink" title="3.1.2 配置更新"></a>3.1.2 配置更新</h4><p>如果需要修改环境变量、pod数量等，可以更新配置文件然后使用<code>kubectl apply -f &lt;filename&gt;</code>。</p>
<h3 id="3-2-配置文件管理"><a href="#3-2-配置文件管理" class="headerlink" title="3.2 配置文件管理"></a>3.2 配置文件管理</h3><h4 id="3-2-1-deployment和service配置文件管理"><a href="#3-2-1-deployment和service配置文件管理" class="headerlink" title="3.2.1 deployment和service配置文件管理"></a>3.2.1 deployment和service配置文件管理</h4><p>一个应用接入k8s只需要编写一个配置文件，包含deployment和service两项配置，如：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div></pre></td><td class="code"><pre><div class="line"><span class="attr">apiVersion:</span> extensions/v1beta1</div><div class="line"><span class="attr">kind:</span> Deployment</div><div class="line"><span class="attr">metadata:</span></div><div class="line"><span class="attr">  name:</span> simples</div><div class="line"><span class="attr">spec:</span></div><div class="line"><span class="attr">  replicas:</span> <span class="number">3</span></div><div class="line"><span class="attr">  template:</span></div><div class="line"><span class="attr">    metadata:</span></div><div class="line"><span class="attr">      labels:</span></div><div class="line"><span class="attr">        app:</span> simples</div><div class="line"><span class="attr">    spec:</span></div><div class="line"><span class="attr">      containers:</span></div><div class="line"><span class="attr">      - name:</span> master</div><div class="line"><span class="attr">        image:</span> imgage.xxx.com/test/simples:latest  <span class="comment"># or just image: redis</span></div><div class="line"><span class="attr">        env:</span></div><div class="line"><span class="attr">        - name:</span> ENV_VAR</div><div class="line"><span class="attr">          value:</span> <span class="string">"10086"</span></div><div class="line"><span class="attr">        ports:</span></div><div class="line"><span class="attr">        - containerPort:</span> <span class="number">9999</span></div><div class="line"><span class="attr">      imagePullSecrets:</span></div><div class="line"><span class="attr">      - name:</span> keyyy</div><div class="line"></div><div class="line">      </div><div class="line"><span class="attr">apiVersion:</span> v1</div><div class="line"><span class="attr">kind:</span> Service</div><div class="line"><span class="attr">metadata:</span></div><div class="line"><span class="attr">  name:</span> aaa</div><div class="line"><span class="attr">  labels:</span></div><div class="line"><span class="attr">    app:</span> aaa</div><div class="line"><span class="attr">spec:</span></div><div class="line"><span class="attr">  ports:</span></div><div class="line">    <span class="comment"># the port that this service should serve on</span></div><div class="line"><span class="attr">  - port:</span> <span class="number">80</span></div><div class="line"><span class="attr">  selector:</span></div><div class="line"><span class="attr">    app:</span> aaa</div></pre></td></tr></table></figure>
<p>每个应用自定义的内容只有环境变量和镜像地址。所有配置使用配置文件统一管理，配置文件使用git管理。</p>
<h4 id="3-2-2-环境变量管理"><a href="#3-2-2-环境变量管理" class="headerlink" title="3.2.2 环境变量管理"></a>3.2.2 环境变量管理</h4><p>通用变量，如数据库配置、mns配置放入configMap，app引用configMap的值。各app自己的变量写入自己的配置文件。</p>
<h3 id="3-3-dashboard"><a href="#3-3-dashboard" class="headerlink" title="3.3 dashboard"></a>3.3 dashboard</h3><p>官方web UI项目：<a href="https://github.com/kubernetes/dashboard" target="_blank" rel="external">https://github.com/kubernetes/dashboard</a></p>
<p>dashboard可以查看相关信息，以及容器日志，不建议在dashboard编辑配置，应该使用配置文件。</p>
<h3 id="3-4-容器管理"><a href="#3-4-容器管理" class="headerlink" title="3.4 容器管理"></a>3.4 容器管理</h3><p>可以使用<code>kubectl</code>命令类似<code>docker</code>命令地关闭、重启、进入容器等。</p>
<h4 id="3-3-1-账户登录"><a href="#3-3-1-账户登录" class="headerlink" title="3.3.1 账户登录"></a>3.3.1 账户登录</h4><p>dashboard 不提供用户登录系统。</p>
<p>使用Nginx的Basic HTTP authentication功能为dashboard提供登录保护，参见<a href="http://nginx.org/en/docs/http/ngx_http_auth_basic_module.html" target="_blank" rel="external">http://nginx.org/en/docs/http/ngx_http_auth_basic_module.html</a>和<a href="http://www.ttlsa.com/nginx/nginx-basic-http-authentication/" target="_blank" rel="external">http://www.ttlsa.com/nginx/nginx-basic-http-authentication/</a>，可以为不同用户设置不同密码。</p>
<h4 id="3-3-2-权限管理"><a href="#3-3-2-权限管理" class="headerlink" title="3.3.2 权限管理"></a>3.3.2 权限管理</h4><p>暂无好方案实现账户权限管理</p>
<h2 id="4-k8s接入备忘录"><a href="#4-k8s接入备忘录" class="headerlink" title="4. k8s接入备忘录"></a>4. k8s接入备忘录</h2><h3 id="api-gateway改造"><a href="#api-gateway改造" class="headerlink" title="api-gateway改造"></a>api-gateway改造</h3><ol>
<li>api service有uwsgi协议改为http协议</li>
<li>api-gateway地址可直接使用service的地址</li>
<li>api service统一使用80端口</li>
</ol>
<h3 id="环境变量改造"><a href="#环境变量改造" class="headerlink" title="环境变量改造"></a>环境变量改造</h3><p>让和环境有关的变量都使用环境变量管理，包括：</p>
<ul>
<li>MySQL数据库<ul>
<li>host</li>
<li>密码</li>
</ul>
</li>
<li>redis地址</li>
<li>Mongo地址</li>
<li>MNS配置</li>
</ul>
<h2 id="其他"><a href="#其他" class="headerlink" title="其他"></a>其他</h2><h3 id="静态资源管理"><a href="#静态资源管理" class="headerlink" title="静态资源管理"></a>静态资源管理</h3><p>静态资源可以直接用Nginx挂在物理机上。</p>
<h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p>因为解决了宿主机端口冲突问题，方便的环境变量管理，可以做到一键创建环境，极大的减少了运维管理成本。</p>
<p>注：kubernetes更新十分迅速，部分信息可能失效，本文根据kubernetes 1.7探索所得。</p>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <link itemprop="mainEntityOfPage" href="http://ifchanged.io/2017/git总结/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="zeroten">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="IFchanged">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2017/git总结/" itemprop="url">
                  git总结
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2017-08-24T21:06:07+08:00">
                2017-08-24
              </time>
            

            

            
          </span>

          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2017/git总结/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count disqus-comment-count"
                        data-disqus-identifier="2017/git总结/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          

          

          

          

        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="git中的位置"><a href="#git中的位置" class="headerlink" title="git中的位置"></a>git中的位置</h2><h3 id="仓库"><a href="#仓库" class="headerlink" title="仓库"></a>仓库</h3><p><img src="http://wx1.sinaimg.cn/large/663aa05agy1fidv3clywuj20ih07wdgn.jpg" alt="仓库"></p>
<ul>
<li><p><strong>工作目录</strong>：对项目的某个版本独立提取出来的内容。 这些从 Git 仓库的压缩数据库中提取出来的文件，放在磁盘上供你使用或修改。</p>
</li>
<li><p><strong>暂存区</strong>：是一个文件，保存了下次将提交的文件列表信息，一般在 Git 仓库目录中。 有时候也被称作`‘索引’’，不过一般说法还是叫暂存区域。</p>
</li>
<li><p><strong>Git仓库目录</strong>：是 Git 用来保存项目的元数据和对象数据库的地方。 这是 Git 中最重要的部分，从其它计算机克隆仓库时，拷贝的就是这里的数据。</p>
<ul>
<li><strong>远程仓库</strong>： 在网络上的仓库，和远程仓库交互的命令只有<code>git fetch</code>和<code>git push</code>，注意<code>git pull</code>实际上执行了fetch后自动执行了merge(默认)或rebase。 </li>
<li><strong>本地仓库</strong>：位于本地的仓库（.git\refs目录），包含本地的数据，有本地分支和追踪分支。</li>
</ul>
</li>
</ul>
<p>基本的 Git 工作流程如下：</p>
<ol>
<li>在工作目录中修改文件。</li>
<li>暂存文件，将文件的快照放入暂存区域。</li>
<li>提交更新，找到暂存区域的文件，将快照永久性存储到 Git 仓库目录。</li>
</ol>
<ul>
<li>HEAD: 一个特殊指针，只想当前所在的本地分支，可以理解为当前分支的别名</li>
<li>head: 指向当前的commit</li>
</ul>
<p>参见: <a href="https://ndpsoftware.com/git-cheatsheet.html" target="_blank" rel="external">https://ndpsoftware.com/git-cheatsheet.html</a></p>
<h3 id="分支"><a href="#分支" class="headerlink" title="分支"></a>分支</h3><ul>
<li>远程分支：如<strong>origin master</strong>，位于远程仓库</li>
<li>追踪分支：如<strong>origin/master</strong>，位于本地仓库（.git\refs\remotes），即git fetch到的位置。</li>
<li>本地分支:如<strong>master</strong>，位于本地仓库(.git\refs\heads)，执行merge、rebase、cherry后更新的分支</li>
</ul>
<h3 id="数据流"><a href="#数据流" class="headerlink" title="数据流"></a>数据流</h3><p><img src="http://wx3.sinaimg.cn/large/663aa05agy1fidv3axzisj20sg0ifacj.jpg" alt="数据流"></p>
<h2 id="基本命令"><a href="#基本命令" class="headerlink" title="基本命令"></a>基本命令</h2><p>参见：<a href="https://git-scm.com/book/zh/v2/Appendix-C%3A-Git-%E5%91%BD%E4%BB%A4-%E8%AE%BE%E7%BD%AE%E4%B8%8E%E9%85%8D%E7%BD%AE" target="_blank" rel="external">Appendix C: Git 命令</a></p>
<h3 id="快照基础"><a href="#快照基础" class="headerlink" title="快照基础"></a>快照基础</h3><ul>
<li><code>git add</code>命令将内容从工作目录添加到暂存区（或称为索引（index）区），以备下次提交</li>
<li><code>git status</code> 命令将为你展示工作区及暂存区域中不同状态的文件</li>
<li><code>git diff</code> 当需要查看任意两棵树的差异时你可以使用 git diff 命令。</li>
<li><code>git commit</code> 命令将所有通过 git add 暂存的文件内容在数据库中创建一个持久的快照，然后将当前分支上的分支指针移到其之上。</li>
<li><code>git reset</code> 命令主要用来根据你传递给动作的参数来执行撤销操作。理解为<strong>重置到</strong>。<strong>会修改commit记录，谨慎操作</strong><ul>
<li><code>git reset file.txt</code>： 取消暂存的文件</li>
<li><code>git reset e43a6fd3e94888d76779ad79fb568ed180e5fcdf</code>：重置到某个点<ul>
<li><code>--soft</code>（默认）：把文件从已commit的分支里扔到暂存区</li>
<li><code>--mixed</code>：把文件从已commit的分支里扔到暂存区（soft的操作），再把暂存区里新添加的文件扔出暂存区</li>
<li><code>--hard</code>:把文件从已commit的分支里扔到暂存区（soft的操作），再把所有东西<strong>扔出硬盘</strong></li>
</ul>
</li>
</ul>
</li>
</ul>
<h3 id="分支与合并"><a href="#分支与合并" class="headerlink" title="分支与合并"></a>分支与合并</h3><ul>
<li><code>git branch</code> 命令实际上是某种程度上的分支管理工具。 它可以列出你所有的分支、创建新分支、删除分支及重命名分支。</li>
<li><code>git checkout</code> 命令用来切换分支，或者检出内容到工作目录。<ul>
<li><code>git checkout</code>：检出某个内容，如本地分支（切换分支）、追踪分支origin/master、某个commit 85bdab6b15、relog中的某个位置71a0f628d</li>
<li><code>git checkout -b/-B</code>：checkout为本地分支时切换分支，其他参数则检出内容后处在游离态(‘detached HEAD’ state),使用-b参数创建分支,-B参数强制创建分支</li>
<li><code>git chekcout -- a.txt</code>:此命令用于丢弃工作目录的修改</li>
</ul>
</li>
<li><code>git merge</code>工具用来合并一个或者多个分支到你已经检出的分支中。 然后它将当前分支指针移动到合并结果上。<ul>
<li>在merge中途，可以使用<code>git merge --abort</code>退出merge并取消修改</li>
</ul>
</li>
<li><code>git log</code> 命令用来展示一个项目的可达历史记录，从最近的提交快照起</li>
<li><code>git stash</code> git stash 命令用来临时地保存一些还没有提交的工作，以便在分支上不需要提交未完成工作就可以清理工作目录。</li>
</ul>
<h3 id="项目分享与更新"><a href="#项目分享与更新" class="headerlink" title="项目分享与更新"></a>项目分享与更新</h3><ul>
<li><code>git fetch</code> 命令与一个远程的仓库交互，并且将远程仓库中有但是在当前仓库的没有的所有信息拉取下来然后存储在你本地数据库中</li>
<li><code>git pull</code> 实际上就是fetch+merge（默认）或者fetch+rebase</li>
<li><code>git push</code> 命令用来与另一个仓库通信，计算你本地数据库与远程仓库的差异，然后将差异推送到另一个仓库中。 </li>
</ul>
<h3 id="检查与比较"><a href="#检查与比较" class="headerlink" title="检查与比较"></a>检查与比较</h3><ul>
<li><code>gut show</code>命令可以以一种简单的人类可读的方式来显示一个 Git 对象。 </li>
</ul>
<h3 id="补丁"><a href="#补丁" class="headerlink" title="补丁"></a>补丁</h3><ul>
<li><code>git cherry-pick</code>命令用来获得在单个提交中引入的变更，然后尝试将作为一个新的提交引入到你当前分支上。</li>
<li><code>git rebase</code>命令基本是是一个自动化的 cherry-pick 命令。 它计算出一系列的提交，然后再以它们在其他地方以同样的顺序一个一个的 cherry-picks 出它们。<strong>会修改commit记录，谨慎操作</strong><ul>
<li>在rebase中途，可以使用<code>git rebase --abort</code>退出并取消修改</li>
</ul>
</li>
<li><code>git revert</code> 命令本质上就是一个逆向的 git cherry-pick 操作。 它将你提交中的变更的以完全相反的方式的应用到一个新创建的提交中，本质上就是撤销或者倒转。</li>
</ul>
<h2 id="使用场景"><a href="#使用场景" class="headerlink" title="使用场景"></a>使用场景</h2><h3 id="拣选工作流"><a href="#拣选工作流" class="headerlink" title="拣选工作流"></a>拣选工作流</h3><ul>
<li><p>场景： 提取某个commit到当前分支。</p>
</li>
<li><p>命令： <code>git cherry-pick e43a6fd3e94888d76779ad79fb568ed180e5fcdf</code></p>
</li>
<li><p>注意事项： 如果要提取多个commit，先提取前面的。</p>
</li>
<li><p>参考：<a href="https://git-scm.com/book/zh/v2/%E5%88%86%E5%B8%83%E5%BC%8F-Git-%E7%BB%B4%E6%8A%A4%E9%A1%B9%E7%9B%AE#_rebase_cherry_pick" target="_blank" rel="external">变基与拣选工作流</a></p>
</li>
</ul>
<h3 id="比较两个分支的commit"><a href="#比较两个分支的commit" class="headerlink" title="比较两个分支的commit"></a>比较两个分支的commit</h3><ul>
<li>命令:<ul>
<li><code>git rev-list ^master HEAD</code> ： 在当前分支但不在master分支的commit</li>
<li><code>git rev-list ^master HEAD|tail -1</code> : 寻找当前分支的开发起点</li>
<li><code>git rev-list A ^B --conut</code> 查找不同commit数量</li>
</ul>
</li>
</ul>
<ul>
<li>注意事项：<ul>
<li>可以增加<code>--pretty</code>参数美化日志结果，如<code>--pretty=oneline</code></li>
</ul>
</li>
</ul>
<h3 id="压缩commit"><a href="#压缩commit" class="headerlink" title="压缩commit"></a>压缩commit</h3><ul>
<li><p>场景：为了让log变得清晰，可以把多个commit合并成一个。但是如果commit较多，又或者经历过merg、cherry等命令，rebase将变得很麻烦。可以使用reset。</p>
</li>
<li><p>命令：</p>
<figure class="highlight crmsh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">git rev-list ^origin/<span class="keyword">master</span> <span class="title">HEAD</span>|tail -<span class="number">1</span> <span class="comment"># 得到commit xxx</span></div><div class="line">git reset --soft xxx~<span class="number">1</span></div><div class="line">git commit -m <span class="string">"获得干净的提交"</span></div></pre></td></tr></table></figure>
</li>
<li><p>注意事项：为了防止误操作，可以使用<code>git branch bak1</code>备份分支，执行完上述命令后使用<code>git diff HEAD　bak1</code>进行比较差异，应得到没有差异的结果。</p>
</li>
</ul>
<h3 id="回滚分支合并"><a href="#回滚分支合并" class="headerlink" title="回滚分支合并"></a>回滚分支合并</h3><ul>
<li><p>场景： 一次分支合并时候，希望进行回滚</p>
</li>
<li><p>命令: <code>git revert -m parent-number commit</code>,如<code>git revert -m 1 08096c7c71429ac044a90bbd43f67aef13a91102</code></p>
</li>
</ul>
<p>一个典型的merge commit：<br><figure class="highlight dts"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">commit a4aebedf433805eb15767f6f1905f3c236ce48bd</div><div class="line"><span class="symbol">Merge:</span> <span class="number">6</span>ee7688 d593ca7</div><div class="line"><span class="symbol">Author:</span> XXX <span class="params">&lt;XXX@qq.com&gt;</span></div><div class="line"><span class="symbol">Date:</span>   Mon Aug <span class="number">22</span> <span class="number">15</span>:<span class="number">40</span>:<span class="number">16</span> <span class="number">2016</span> +<span class="number">0800</span></div><div class="line">    XXXXX</div></pre></td></tr></table></figure></p>
<p>其中merge字段中的6ee7688 d593ca7就是两个parent commit，<br><figure class="highlight gherkin"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">      a4aebedf4</div><div class="line">         /\</div><div class="line"> 6ee7688|<span class="string"> </span>|d593ca7</div><div class="line">(master)|<span class="string"> </span>|<span class="string"> (feature)</span></div><div class="line">        |<span class="string"> </span>|</div><div class="line">        |<span class="string"> </span>|</div></pre></td></tr></table></figure></p>
<p>-m 参数指定要回滚到parent commit，值为1或2，即第1个还是第2个。如上图，我们想回滚掉feature分之，回到合并之前的master，则选择1。</p>
<ul>
<li>注意事项：通常使用Gitlab的merge request合并的分之都选1，当不确定时可以使用<code>git show xxxx</code>查看一下两个父节点分别是什么内容。</li>
</ul>
<h3 id="回滚到某个提交"><a href="#回滚到某个提交" class="headerlink" title="回滚到某个提交"></a>回滚到某个提交</h3><ul>
<li>场景：如果上线失败，想回滚到上次上线的版本，上线到昨天的某个版本等待。得到版本号后就可以回滚<strong>到</strong>那个版本。</li>
<li>命令：<figure class="highlight sql"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">git <span class="keyword">reset</span> <span class="comment">--hard a4aebedf433805eb15767f6f1905f3c236ce48bd</span></div><div class="line">git <span class="keyword">reset</span> <span class="comment">--soft origin/master</span></div><div class="line">git <span class="keyword">commit</span> -am <span class="string">"revert to a4aebedf433805eb15767f6f1905f3c236ce48bd"</span></div></pre></td></tr></table></figure>
</li>
</ul>
<h3 id="撤销本地操作"><a href="#撤销本地操作" class="headerlink" title="撤销本地操作"></a>撤销本地操作</h3><ul>
<li>场景： 如删除错分支，reset命令错commit时，可以使用relog查看操作日志，并撤销操作。</li>
<li><p>命令:</p>
<figure class="highlight applescript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">git reflog <span class="comment"># 查找需要恢复到的id</span></div><div class="line">git reset <span class="comment">--head XXX</span></div></pre></td></tr></table></figure>
</li>
<li><p>注意事项：reflog只记录HEAD的值，即每一次提交或改变分支，所以没有commit的内容无法用reflog恢复。</p>
</li>
<li>参考：<a href="https://git-scm.com/book/zh/v2/Git-%E5%86%85%E9%83%A8%E5%8E%9F%E7%90%86-%E7%BB%B4%E6%8A%A4%E4%B8%8E%E6%95%B0%E6%8D%AE%E6%81%A2%E5%A4%8D" target="_blank" rel="external">维护与数据恢复</a></li>
</ul>
<h3 id="把本地重置到远程分支的版本"><a href="#把本地重置到远程分支的版本" class="headerlink" title="把本地重置到远程分支的版本"></a>把本地重置到远程分支的版本</h3><ul>
<li>场景: 如获取最新的master或某个分支覆盖本地代码</li>
<li>命令：</li>
</ul>
<p>把当前的分支变为远程某分支<br><figure class="highlight maxima"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">git fetch </div><div class="line">git <span class="built_in">reset</span> --hard <span class="built_in">origin</span>/master</div></pre></td></tr></table></figure></p>
<p>或</p>
<p>检出某个远程分支强制到某本地分支</p>
<figure class="highlight crmsh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">git fetch</div><div class="line">git checkout origin/<span class="keyword">master</span> <span class="title">-B</span> <span class="literal">master</span></div></pre></td></tr></table></figure>
<h3 id="二分查找问题commit"><a href="#二分查找问题commit" class="headerlink" title="二分查找问题commit"></a>二分查找问题commit</h3><ul>
<li>场景：比如一次上线有多个pr带来的代码，本地分支commit几次后发现有问题，用二分查找快速的定位问题</li>
<li><p>命令：</p>
<ul>
<li>暴力checkout法：手动git checkout  HEAD~1，HEAD~10,HEAD~5这样手动切换到某个commit</li>
<li><p>bisect命令：</p>
  <figure class="highlight mipsasm"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">git <span class="keyword">bisect </span>start <span class="comment">#标记开始</span></div><div class="line">git <span class="keyword">bisect </span><span class="keyword">bad </span><span class="comment"># 标记当前有问题 </span></div><div class="line">git <span class="keyword">bisect </span>good <span class="built_in">v1</span>.<span class="number">0</span> 标记一个没问题的起点</div></pre></td></tr></table></figure>
<p>  而后git会自动开始二分查找，用户使用git bisect bad或者git bisect good进行标记当前commit的情况，直到能确定因为问题的commit。</p>
</li>
</ul>
</li>
</ul>
<h2 id="总结"><a href="#总结" class="headerlink" title="总结"></a>总结</h2><p>git有工作目录、暂存区、仓库三个位置，里面有所有的git追踪的内容。使用<code>git checkout</code>能够<strong>检出（获得）</strong>分支中的内容，<code>git reset</code>能够<strong>重置</strong>到某个点。<code>git diff</code>比较文件，<code>git rev-list</code>比较commit。<code>git log</code>查看commit日志，<code>git reflog</code>查看本地<code>HEAD</code>移动记录。</p>
<h2 id="学习资料"><a href="#学习资料" class="headerlink" title="学习资料"></a>学习资料</h2><ul>
<li>《Pro Git》 <a href="https://git-scm.com/book/zh/v2" target="_blank" rel="external">https://git-scm.com/book/zh/v2</a><ul>
<li><a href="https://git-scm.com/book/zh/v2/Appendix-C%3A-Git-%E5%91%BD%E4%BB%A4-%E8%AE%BE%E7%BD%AE%E4%B8%8E%E9%85%8D%E7%BD%AE" target="_blank" rel="external">Appendix C: Git 命令</a></li>
</ul>
</li>
<li>Reference <a href="https://git-scm.com/docs" target="_blank" rel="external">https://git-scm.com/docs</a></li>
<li>User manual: <a href="https://git-scm.com/docs/user-manual.html" target="_blank" rel="external">https://git-scm.com/docs/user-manual.html</a></li>
<li><a href="https://www.atlassian.com/git" target="_blank" rel="external">https://www.atlassian.com/git</a></li>
<li>git everyday <a href="https://git-scm.com/docs/everyday" target="_blank" rel="external">https://git-scm.com/docs/everyday</a></li>
<li><a href="http://ladder1984.github.io/tags/git/" target="_blank" rel="external">http://ladder1984.github.io/tags/git/</a></li>
</ul>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <link itemprop="mainEntityOfPage" href="http://ifchanged.io/2017/浅谈行为驱动开发(BDD)/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="zeroten">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="IFchanged">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2017/浅谈行为驱动开发(BDD)/" itemprop="url">
                  浅谈行为驱动开发(BDD)
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2017-05-16T00:45:44+08:00">
                2017-05-16
              </time>
            

            

            
          </span>

          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2017/浅谈行为驱动开发(BDD)/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count disqus-comment-count"
                        data-disqus-identifier="2017/浅谈行为驱动开发(BDD)/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          

          

          

          

        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="简介"><a href="#简介" class="headerlink" title="简介"></a>简介</h2><p>BDD（Behaviour-Driven Development行为驱动开发）是一种敏捷开放方式，鼓励开发者、测试、业务方参与开发协作，虽然多数情况下只有开发和测试参与。BDD使用自然语言描述用户故事，从而让各方都可读、可写测试用例，并且用通用的语言精确描述软件的行为。</p>
<h3 id="核心思想"><a href="#核心思想" class="headerlink" title="核心思想"></a>核心思想</h3><p>一种测试方案，模拟用户的真实行为，来保证各个软件模块执行后的最终结果是正确的。</p>
<h2 id="运作方式"><a href="#运作方式" class="headerlink" title="运作方式"></a>运作方式</h2><h3 id="文件组织"><a href="#文件组织" class="headerlink" title="文件组织"></a>文件组织</h3><p>用Gherkin语法描述step，一个个关联且有序的step组成完整的scenario，相关的scenario放入一个feature文件中。</p>
<h3 id="Gherkin语法"><a href="#Gherkin语法" class="headerlink" title="Gherkin语法"></a>Gherkin语法</h3><ul>
<li>Given：把系统置为某种状态，也就是准备数据</li>
<li>When：描述用户行为，也就是要测试的step</li>
<li>Then：获得结果，通常用于校验</li>
<li>And：表示使用上一个step的关键词</li>
</ul>
<h3 id="标记"><a href="#标记" class="headerlink" title="标记"></a>标记</h3><p>用tag来标记不同模块，也用tag来标记通过和未通过的scenario</p>
<h3 id="执行"><a href="#执行" class="headerlink" title="执行"></a>执行</h3><p>令人怀念的<code>behave -kt @xxx</code>命令</p>
<h3 id="Jenkins执行"><a href="#Jenkins执行" class="headerlink" title="Jenkins执行"></a>Jenkins执行</h3><p>可用Jenkins输出完整报告。在Jenkins执行时可用tag或目录分割多组feature，则并行执行，理论最短时间为最长scenario的耗时。</p>
<p>参考：</p>
<ul>
<li><a href="https://github.com/cucumber/cucumber/wiki/Given-When-Then" target="_blank" rel="external">Gherkin</a></li>
<li><a href="https://github.com/cucumber/cucumber/wiki/Given-When-Then" target="_blank" rel="external">Given When Then</a></li>
</ul>
<h2 id="优缺点"><a href="#优缺点" class="headerlink" title="优缺点"></a>优缺点</h2><h3 id="优点"><a href="#优点" class="headerlink" title="优点"></a>优点</h3><p>以用户故事为测试单位，保证软件在真实、连贯场景中的正确性。</p>
<h3 id="缺点"><a href="#缺点" class="headerlink" title="缺点"></a>缺点</h3><p>当业务越来复杂、微服务越来越多时，这种集成测试方案难以维护，对开发者要求较高。在没有良好并行方案时，速度很慢。</p>
<h2 id="技术"><a href="#技术" class="headerlink" title="技术"></a>技术</h2><ul>
<li>库：behave，其他Python库实现：Lettuce、radish</li>
<li>处理异步：celery使用同步模式、异步消息消费者采用子进程阻塞调用</li>
<li>夸服务调用：BDD SERVER，使用http服务器传递step，并使用sub step调用，用http response返回结果</li>
<li>第三方服务：各种mock</li>
<li>IDE支持：Pycharm</li>
</ul>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <link itemprop="mainEntityOfPage" href="http://ifchanged.io/2017/git-tag应用/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="zeroten">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="IFchanged">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2017/git-tag应用/" itemprop="url">
                  git tag应用
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2017-02-28T14:59:13+08:00">
                2017-02-28
              </time>
            

            

            
          </span>

          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2017/git-tag应用/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count disqus-comment-count"
                        data-disqus-identifier="2017/git-tag应用/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          

          

          

          

        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="1-Tag概述"><a href="#1-Tag概述" class="headerlink" title="1. Tag概述"></a>1. Tag概述</h2><blockquote>
<p>像其他版本控制系统（VCS）一样，Git 可以给历史中的某一个提交打上标签，以示重要。 比较有代表性的是人们会使用这个功能来标记发布结点（v1.0 等等）。</p>
</blockquote>
<p>参考：  </p>
<ul>
<li><a href="https://git-scm.com/book/zh/v2/Git-%E5%9F%BA%E7%A1%80-%E6%89%93%E6%A0%87%E7%AD%BE" target="_blank" rel="external">https://git-scm.com/book/zh/v2/Git-%E5%9F%BA%E7%A1%80-%E6%89%93%E6%A0%87%E7%AD%BE</a></li>
<li><code>git help tag</code></li>
</ul>
<h3 id="1-1-命令"><a href="#1-1-命令" class="headerlink" title="1.1 命令"></a>1.1 命令</h3><p>tag的命令与分支相似。</p>
<ul>
<li>列出标签: <code>git tag</code></li>
<li>创建标签: <code>git tag tag123</code><ul>
<li>附注标签: <code>git tag -a v1.4 -m &#39;my version 1.4&#39;</code></li>
<li>打在制定版本: <code>git tag -a v1.2 9fceb02</code> </li>
</ul>
</li>
<li>查看标签内容: <code>git show v1.4</code> 或 <code>git log v1.4</code><ul>
<li>按照版本排序：<code>git tag --sort=&quot;version:refname</code></li>
<li>搜索： <code>git tag -l &lt;pattern&gt;</code>，如<code>git tag -l &quot;v*&quot;</code></li>
</ul>
</li>
<li>push标签：git push不会推送本地标签<ul>
<li>push特定标签： <code>git push origin [tagname]</code></li>
<li>push所有标签： <code>git push origin --tags</code></li>
</ul>
</li>
<li>检出标签: <code>git checkout -b version2 v2.0.0</code></li>
<li>删除标签：<ul>
<li>删除本地标签: <code>git tag -d v0.1</code>      批量：<code>git tag -l &quot;vTEST*&quot;|xargs git tag -d</code></li>
<li>删除远程标签: <code>git push origin --delete v0.1</code>   批量：<code>git tag -l &quot;vTEST*&quot;|xargs git push origin --delete</code></li>
</ul>
</li>
</ul>
<h2 id="2-配置"><a href="#2-配置" class="headerlink" title="2. 配置"></a>2. 配置</h2><h3 id="2-1-jenkins"><a href="#2-1-jenkins" class="headerlink" title="2.1 jenkins"></a>2.1 jenkins</h3><p>增加构建后操作的Publisher：</p>
<p><img src="/images/git_tag1.png" alt=""></p>
<ul>
<li>v168形式的标签表示每次 jenkins上线构建的版本,使用<code>git tag --sort=&quot;version:refname&quot; -l &quot;v*&quot;</code>获得按照版本排序的tag。</li>
</ul>
<h3 id="2-2-Gitlab"><a href="#2-2-Gitlab" class="headerlink" title="2.2 Gitlab"></a>2.2 Gitlab</h3><p>需要添加jenkins用户为develop权限。</p>
<h2 id="应用"><a href="#应用" class="headerlink" title="应用"></a>应用</h2><ol>
<li>比较</li>
</ol>
<ul>
<li>文件比较：<code>git diff v98 master</code>,此命令比较v98和master文件不同。常用于比较两个版本是否一致。</li>
<li><p>commit：<code>git diff ^v98 master</code>，此命令比较不在v98上但是在master上的commit有哪些。常用于比较两个版本不同的commit</p>
<ul>
<li><p>取得远程master上没有上线的commit：</p>
<figure class="highlight crmsh"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">git fetch &amp;&amp; git log `git <span class="keyword">tag</span> <span class="title">--sort</span>=<span class="string">"version:refname"</span> -l <span class="string">"v*"</span>|tail -<span class="number">1</span>`..origin/<span class="literal">master</span></div></pre></td></tr></table></figure>
<p>或者</p>
<figure class="highlight crmsh"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">git fetch &amp;&amp; git rev-list ^`git <span class="keyword">tag</span> <span class="title">--sort</span>=<span class="string">"version:refname"</span> -l <span class="string">"v*"</span>|tail -<span class="number">1</span>` origin/<span class="keyword">master</span> <span class="title">--pretty</span>=oneline</div></pre></td></tr></table></figure>
</li>
</ul>
</li>
</ul>
<p><strong>注</strong>：<code>--sort=&quot;version:refname&quot; -l &quot;v*&quot;</code>要求v开头的tag都是jenkins打出来的，且要求git 2.1及以上版本</p>
<ol>
<li>回滚</li>
</ol>
<p>todo</p>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <link itemprop="mainEntityOfPage" href="http://ifchanged.io/2016/git mater分支回滚指南/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="zeroten">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="IFchanged">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2016/git mater分支回滚指南/" itemprop="url">
                  git master分支回滚指南
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2016-08-24T23:44:27+08:00">
                2016-08-24
              </time>
            

            

            
          </span>

          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2016/git mater分支回滚指南/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count disqus-comment-count"
                        data-disqus-identifier="2016/git mater分支回滚指南/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          

          

          

          

        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="1-概述"><a href="#1-概述" class="headerlink" title="1. 概述"></a>1. 概述</h2><h3 id="1-1-master分支回滚的特殊性"><a href="#1-1-master分支回滚的特殊性" class="headerlink" title="1.1 master分支回滚的特殊性"></a>1.1 master分支回滚的特殊性</h3><ol>
<li>多人协作，修改提交历史的方式易造成冲突</li>
<li>希望所有操作的记录都是保存的，避免丢失代码</li>
<li>希望没有master权限的人也能按照正常合并流程进行回滚</li>
</ol>
<p>所以，以下的方法都是不会修改提交历史了，操作可以使用正常合并流程。</p>
<h3 id="1-2-场景描述"><a href="#1-2-场景描述" class="headerlink" title="1.2 场景描述"></a>1.2 场景描述</h3><ol>
<li>回滚某个或某些commit</li>
<li>回滚分支合并（merge commit）</li>
<li>回滚<strong>到</strong>某个提交</li>
</ol>
<h2 id="2-回滚方法"><a href="#2-回滚方法" class="headerlink" title="2. 回滚方法"></a>2. 回滚方法</h2><h3 id="2-1-回滚某个或某些commit"><a href="#2-1-回滚某个或某些commit" class="headerlink" title="2.1 回滚某个或某些commit"></a>2.1 回滚某个或某些commit</h3><figure class="highlight armasm"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="symbol">git</span> <span class="keyword">revert </span>commit</div></pre></td></tr></table></figure>
<p>如：<code>git revet 08096c7</code></p>
<h3 id="2-2-回滚分支合并（merge-commit）"><a href="#2-2-回滚分支合并（merge-commit）" class="headerlink" title="2.2 回滚分支合并（merge commit）"></a>2.2 回滚分支合并（merge commit）</h3><figure class="highlight applescript"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">git revert -m parent-<span class="built_in">number</span> commit</div></pre></td></tr></table></figure>
<p>如<code>git revert -m 1 08096c7c71429ac044a90bbd43f67aef13a91102</code></p>
<p>一个典型的merge commit：<br><figure class="highlight dts"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">commit a4aebedf433805eb15767f6f1905f3c236ce48bd</div><div class="line"><span class="symbol">Merge:</span> <span class="number">6</span>ee7688 d593ca7</div><div class="line"><span class="symbol">Author:</span> XXX <span class="params">&lt;XXX@qq.com&gt;</span></div><div class="line"><span class="symbol">Date:</span>   Mon Aug <span class="number">22</span> <span class="number">15</span>:<span class="number">40</span>:<span class="number">16</span> <span class="number">2016</span> +<span class="number">0800</span></div><div class="line"></div><div class="line">    XXXXX</div></pre></td></tr></table></figure></p>
<p>其中merge字段中的6ee7688 d593ca7就是两个parent commit，<br><figure class="highlight gherkin"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">      a4aebedf4</div><div class="line">         /\</div><div class="line"> 6ee7688|<span class="string"> </span>|d593ca7</div><div class="line">(master)|<span class="string"> </span>|<span class="string"> (feature)</span></div><div class="line">        |<span class="string"> </span>|</div><div class="line">        |<span class="string"> </span>|</div></pre></td></tr></table></figure></p>
<p>-m 参数指定要回滚到parent commit，值为1或2，即第1个还是第2个。如上图，我们想回滚<strong>掉</strong>feature分之，回<strong>到</strong>合并之前的master，则选择1.通常使用Gitlab的merge request合并的分之都选1.</p>
<h3 id="2-3-回滚到某个提交"><a href="#2-3-回滚到某个提交" class="headerlink" title="2.3 回滚到某个提交"></a>2.3 回滚到某个提交</h3><p>如要把master回滚到tag v100:<br><figure class="highlight sql"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">git <span class="keyword">reset</span> <span class="comment">--hard v100</span></div><div class="line">git <span class="keyword">reset</span> <span class="comment">--soft origin/master</span></div><div class="line">git <span class="keyword">commit</span> -am <span class="string">"revert to v100"</span></div></pre></td></tr></table></figure></p>
<p>回滚完毕后，可以使用<code>git diff head v100</code>比较是否还有不同，如果有不同，则说明操作错误。</p>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <link itemprop="mainEntityOfPage" href="http://ifchanged.io/2016/peewee-note2/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="zeroten">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="IFchanged">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2016/peewee-note2/" itemprop="url">
                  peewee笔记(2)——构建自已的peewee文档
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2016-03-28T20:17:01+08:00">
                2016-03-28
              </time>
            

            

            
          </span>

          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2016/peewee-note2/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count disqus-comment-count"
                        data-disqus-identifier="2016/peewee-note2/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          

          

          

          

        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="背景"><a href="#背景" class="headerlink" title="背景"></a>背景</h2><p>开源软件的一大好处就是我们可以根据自己的需要进行定制或优化，但这带来的问题是，修改可能无法合并的回社区。随着时间流逝，自己的版本可能和官方版本差别越来越大，也无法合并官方的代码更新。如果后续开发者一直阅读官方文档就会有问题，所有需要构建自己的文档。</p>
<p>打开peewee官方文档<a href="http://docs.peewee-orm.com/en/latest/" target="_blank" rel="external">http://docs.peewee-orm.com/en/latest/</a>，我们可以看到只提供latest、stable版本文档，可能和我们定制的已经千差万别。好在peewee文档使用Sphinx构建，易于修改部署。</p>
<h2 id="部署文档"><a href="#部署文档" class="headerlink" title="部署文档"></a>部署文档</h2><p>好在github上我们可以找到历史版本的文档，以2.6.4为例。</p>
<ol>
<li>安装Sphinx：<code>pip install sphinx</code></li>
<li>从官方git（<a href="https://github.com/coleifer/peewee" target="_blank" rel="external">https://github.com/coleifer/peewee</a>）下载peewee源码并切换到tag 2.6.4。</li>
<li>进入项目内doc/目录，执行<code>make.bat html</code>(Windows)或<code>make html</code>(Linux)生成静态网站目录_build/index/ 。</li>
<li>把2的目录找个服务器放。</li>
</ol>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <link itemprop="mainEntityOfPage" href="http://ifchanged.io/2016/peewee-note1/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="zeroten">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="IFchanged">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2016/peewee-note1/" itemprop="url">
                  peewee笔记(1)——基本语法
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2016-03-23T10:44:27+08:00">
                2016-03-23
              </time>
            

            

            
          </span>

          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2016/peewee-note1/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count disqus-comment-count"
                        data-disqus-identifier="2016/peewee-note1/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          

          

          

          

        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="peewee使用指南"><a href="#peewee使用指南" class="headerlink" title="peewee使用指南"></a>peewee使用指南</h1><p>本系列文章基于peewee 2.6.4，同时会参照Django Orm做点比较。</p>
<h2 id="1-peewee介绍"><a href="#1-peewee介绍" class="headerlink" title="1.peewee介绍"></a>1.peewee介绍</h2><p>peewee是一个轻量级Python ORM，支持Sqlite、MYSQL、PostgresqlD等数据库。</p>
<h2 id="2-使用指南"><a href="#2-使用指南" class="headerlink" title="2.使用指南"></a>2.使用指南</h2><h3 id="2-1-连接mysql"><a href="#2-1-连接mysql" class="headerlink" title="2.1.连接mysql"></a>2.1.连接mysql</h3><h4 id="2-1-1-连接形式"><a href="#2-1-1-连接形式" class="headerlink" title="2.1.1.连接形式"></a>2.1.1.连接形式</h4><p>使用url连接，方式和django类似，如：<br><figure class="highlight xquery"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line">DATABASES = &#123;</div><div class="line">    <span class="string">'default'</span>: &#123;</div><div class="line">        <span class="string">'ENGINE'</span>: <span class="string">'mysql'</span>,</div><div class="line">        <span class="string">'NAME'</span>: <span class="string">'name'</span>,</div><div class="line">        <span class="string">'USER'</span>: <span class="string">'user'</span>,                      </div><div class="line">        <span class="string">'PASSWORD'</span>: <span class="string">'pass'</span>,                  </div><div class="line">        <span class="string">'HOST'</span>: <span class="string">'url'</span>,</div><div class="line">        <span class="string">'PORT'</span>: <span class="string">''</span>,</div><div class="line">        <span class="string">'CONN_MAX_AGE'</span>: <span class="number">100</span></div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<h3 id="2-2-model定义"><a href="#2-2-model定义" class="headerlink" title="2.2.model定义"></a>2.2.model定义</h3><h4 id="2-2-1-概述"><a href="#2-2-1-概述" class="headerlink" title="2.2.1.概述"></a>2.2.1.概述</h4><p>一句话描述：<strong>和Django一样用。</strong></p>
<p>model定义基本和Django一致，<br>需要注意的是：</p>
<ol>
<li>属性和Django基本一致</li>
<li>有些Django并不影响使用的东西peewee不支持，目前注意到的是<code>Field.choices</code>。</li>
<li>peewee可以使用<code>playhouse.signals</code>实现信号机制。</li>
</ol>
<p>详见：<a href="http://docs.peewee-orm.com/en/stable/peewee/models.html#fields" target="_blank" rel="external">http://docs.peewee-orm.com/en/stable/peewee/models.html#fields</a></p>
<h2 id="3-ORM操作（CRUD）"><a href="#3-ORM操作（CRUD）" class="headerlink" title="3.ORM操作（CRUD）"></a>3.ORM操作（CRUD）</h2><p>示例Model：</p>
<figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">from</span> peewee <span class="keyword">import</span> *</div><div class="line"></div><div class="line">db = SqliteDatabase(<span class="string">'people.db'</span>)</div><div class="line"></div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">Person</span><span class="params">(Model)</span>:</span></div><div class="line">    name = CharField(default=<span class="string">''</span>)</div><div class="line">    age = IntegerField(default=<span class="number">0</span>) </div><div class="line"></div><div class="line">    <span class="class"><span class="keyword">class</span> <span class="title">Meta</span>:</span></div><div class="line">        database = db <span class="comment"># This model uses the "people.db" database.</span></div></pre></td></tr></table></figure>
<p>注：这是个model示例，实际上’database=db’已经封装在<code>db.model.Model</code>中，在python-service-base中不用写。</p>
<h3 id="3-1-增加（Create）"><a href="#3-1-增加（Create）" class="headerlink" title="3.1.增加（Create）"></a>3.1.增加（Create）</h3><ol>
<li>create()方法：</li>
</ol>
<figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">grandma =Person.create(name=<span class="string">'Grandma'</span>, age = <span class="number">1</span>)</div></pre></td></tr></table></figure>
<ol>
<li>save()方法</li>
</ol>
<figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">person = Person()</div><div class="line">person.name = <span class="string">'bill'</span></div><div class="line">person.age =<span class="number">10</span></div><div class="line">person.save()</div></pre></td></tr></table></figure>
<h3 id="3-2-查（Retrieve）"><a href="#3-2-查（Retrieve）" class="headerlink" title="3.2.查（Retrieve）"></a>3.2.查（Retrieve）</h3><p>peewee中查询记录分为get（查询单条记录）、select(条件查询批量记录)。</p>
<h4 id="3-2-1-查询单条记录"><a href="#3-2-1-查询单条记录" class="headerlink" title="3.2.1.查询单条记录"></a>3.2.1.查询单条记录</h4><p>注：get方法获取不存在的记录会抛出异常。</p>
<ol>
<li><p><code>Product.get(name=&#39;abc&#39;)</code><br>或者<br><code>Product.get(Product.name==&#39;abc&#39;)</code></p>
</li>
<li><p><code>Product.select().where(Product.name==&#39;abc&#39;).get()</code></p>
</li>
<li><code>Product.select().where(Product.name==&#39;abc&#39;).first()</code></li>
</ol>
<p><strong>注:</strong></p>
<ol>
<li>get()支持name=’abc’也支持Product.name==’abc’的写法，where<strong>只</strong>Product.name==’abc’。</li>
<li>前两种都是get方法，查询不到会抛出异常，select方法查询不到返回None。</li>
</ol>
<h4 id="3-2-2-查询全部"><a href="#3-2-2-查询全部" class="headerlink" title="3.2.2.查询全部"></a>3.2.2.查询全部</h4><p><code>Product.select()</code>等价于Django中的<code>Product.select().all()</code>，返回一个可迭代的SelectQuery对象。</p>
<h4 id="3-2-3-条件查询"><a href="#3-2-3-条件查询" class="headerlink" title="3.2.3.条件查询"></a>3.2.3.条件查询</h4><figure class="highlight fortran"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="built_in">Product</span>.<span class="keyword">select</span>().<span class="keyword">where</span>(<span class="built_in">Product</span>.<span class="keyword">name</span>==<span class="string">'abc'</span>)</div></pre></td></tr></table></figure>
<p>返回一个可迭代的SelectQuery对象。</p>
<ul>
<li>或(OR)查询：<strong>|</strong>，例如：<code>User.select().where((User.is_staff == True) | (User.is_superuser == True))</code></li>
<li>且(AND)查询:<strong>&amp;</strong>，例如：<code>Product.select().where(Product.name==&#39;abc&#39;,Product.owner_id==10086)</code> 或者 <code>Product.select().where((Product.name==&#39;abc&#39;) &amp; (Product.owner_id==10086))</code></li>
<li>非(NOT)：<strong>~</strong>,没用过。。。</li>
<li><p>比较：peewee支持如下比较符</p>
  <figure class="highlight applescript"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line">==  x <span class="keyword">equals</span> y</div><div class="line">&lt;   x <span class="keyword">is</span> <span class="keyword">less than</span> y</div><div class="line">&lt;=  x <span class="keyword">is</span> <span class="keyword">less than or equal</span> <span class="keyword">to</span> y</div><div class="line">&gt;   x <span class="keyword">is</span> <span class="keyword">greater than</span> y</div><div class="line">&gt;=  x <span class="keyword">is</span> <span class="keyword">greater than</span> <span class="keyword">or</span> <span class="keyword">equal</span> <span class="keyword">to</span> y</div><div class="line">!=  x <span class="keyword">is</span> <span class="keyword">not</span> <span class="keyword">equal</span> <span class="keyword">to</span> y</div><div class="line">&lt;&lt;  x IN y, <span class="keyword">where</span> y <span class="keyword">is</span> a <span class="built_in">list</span> <span class="keyword">or</span> query</div><div class="line">&gt;&gt;  x IS y, <span class="keyword">where</span> y <span class="keyword">is</span> None/NULL</div><div class="line">%   x LIKE y <span class="keyword">where</span> y may <span class="keyword">contain</span> wildcards</div><div class="line">**  x ILIKE y <span class="keyword">where</span> y may <span class="keyword">contain</span> wildcards</div><div class="line">~   Negation</div></pre></td></tr></table></figure>
</li>
<li><p>其他查询</p>
  <figure class="highlight vbnet"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line">.contains(substr) 	Wild-card search <span class="keyword">for</span> substring.</div><div class="line">.startswith(prefix) 	Search <span class="keyword">for</span> values beginning <span class="keyword">with</span> prefix.</div><div class="line">.endswith(suffix) 	Search <span class="keyword">for</span> values ending <span class="keyword">with</span> suffix.</div><div class="line">.between(low, high) 	Search <span class="keyword">for</span> values between low <span class="keyword">and</span> high.</div><div class="line">.regexp(exp) 	Regular expression match.</div><div class="line">.bin_and(value) 	<span class="keyword">Binary</span> <span class="keyword">AND</span>.</div><div class="line">.bin_or(value) 	<span class="keyword">Binary</span> <span class="keyword">OR</span>.</div><div class="line">.in_(value) 	<span class="keyword">IN</span> lookup (identical <span class="keyword">to</span> &lt;&lt;).</div><div class="line">.not_in(value) 	<span class="keyword">NOT</span> <span class="keyword">IN</span> lookup.</div><div class="line">.is_null(is_null) 	<span class="keyword">IS</span> NULL <span class="keyword">or</span> <span class="keyword">IS</span> <span class="keyword">NOT</span> NULL. Accepts <span class="built_in">boolean</span> param.</div><div class="line">.concat(other) 	Concatenate two strings <span class="keyword">using</span> ||.</div></pre></td></tr></table></figure>
</li>
</ul>
<p>示例：</p>
<p>查询id in ids，ids是个list。</p>
<ul>
<li><code>Product.select().where(Product.id &lt;&lt; ids)</code></li>
<li><code>Product.select().where(Product.id.in_(ids))</code></li>
</ul>
<p>等价于Django中的<code>Product.objects.filter(id__=ids)</code>。</p>
<h4 id="3-2-3-计数count"><a href="#3-2-3-计数count" class="headerlink" title="3.2.3.计数count"></a>3.2.3.计数count</h4><p><code>Product.select().where(Product.name==&#39;abc&#39;).count()</code>。<br>SelectQuery对象并不支持len()方法，即执行<code>len(Product.select().where(Product.name==&#39;abc&#39;))</code>会抛出TypeError异常。虽然可以实现支持len，但滥用可能带来性能风险。</p>
<h4 id="3-2-5-排序order-by"><a href="#3-2-5-排序order-by" class="headerlink" title="3.2.5.排序order_by"></a>3.2.5.排序order_by</h4><ul>
<li>降序：使用”-“或者”desc()”,<code>Tweet.select().order_by(Tweet.created_date.desc())</code> 等价于 <code>Tweet.select().order_by(-Tweet.created_date)</code></li>
<li>升序：使用”+”或者”asc()”或者不写，<code>User.select().order_by(+User.username)</code></li>
</ul>
<h3 id="3-3-删除（Delete）"><a href="#3-3-删除（Delete）" class="headerlink" title="3.3.删除（Delete）"></a>3.3.删除（Delete）</h3><p><strong>建议使用方法1</strong></p>
<ol>
<li>Model.delete (Python class method, in API Reference)<br><code>mall_models.Order.delete().where(mall_models.Order.id=order.id).execute()</code><br>或者<figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">p = mall_models.Order.delete().where(mall_models.Order.id=order.id)</div><div class="line">p.execute()</div></pre></td></tr></table></figure>
</li>
</ol>
<p>也就是执行了execute()才会执行删除操作。</p>
<ol>
<li><p>Model.delete_instance (Python method, in API Reference)</p>
<figure class="highlight stylus"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"><span class="selector-tag">p</span> = Product.get(Product.name==<span class="string">'abc'</span>)</div><div class="line"><span class="selector-tag">p</span>.elete_instance()</div></pre></td></tr></table></figure>
</li>
<li><p>DeleteQuery<br><code>dq = DeleteQuery(User).where(User.active == False).execute()</code></p>
</li>
</ol>
<h3 id="3-4-改（Update）"><a href="#3-4-改（Update）" class="headerlink" title="3.4.改（Update）"></a>3.4.改（Update）</h3><ol>
<li>update修改(推荐)<figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">query = Stat.update(counter=Stat.counter + <span class="number">1</span>).where(Stat.url == request.url)</div><div class="line">query.execute()</div></pre></td></tr></table></figure>
</li>
</ol>
<p>同delete,也就是执行了execute()才会执行update操作。</p>
<ol>
<li>save修改<figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">for</span> stat <span class="keyword">in</span> Stat.select().where(Stat.url == request.url):</div><div class="line">     stat.counter += <span class="number">1</span></div><div class="line">     stat.save()</div></pre></td></tr></table></figure>
</li>
</ol>
<p>两种方式都类似Django语句，<strong>需要特别注意的是，peewee的update是原子的（Atomic ）</strong>，在并发情况下可靠，即peewee的update语句效果等价于Django使用F表达式的update，如<code>rules.update(remained_count=F(&#39;remained_count&#39;) - 1, get_count=F(&#39;get_count&#39;) + 1)</code></p>
<h2 id="4-外键与join"><a href="#4-外键与join" class="headerlink" title="4.外键与join"></a>4.外键与join</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div></pre></td><td class="code"><pre><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">OrderHasProduct</span><span class="params">(models.Model)</span>:</span></div><div class="line">	order = models.ForeignKey(Order)</div><div class="line">	product = models.ForeignKey(Product, related_name=<span class="string">'product'</span>)</div><div class="line">	price = models.FloatField()  <span class="comment"># 商品单价</span></div><div class="line"></div><div class="line"></div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">Order</span><span class="params">(models.Model)</span>:</span></div><div class="line">	order_id = models.CharField(max_length=<span class="number">100</span>)  <span class="comment"># 订单号</span></div><div class="line">	webapp_user_id = models.IntegerField()  <span class="comment"># WebApp用户的id</span></div><div class="line">	webapp_id = models.CharField(max_length=<span class="number">20</span>, verbose_name=<span class="string">'店铺ID'</span>)  <span class="comment"># webapp,订单成交的店铺id</span></div><div class="line">	webapp_source_id = models.IntegerField(default=<span class="number">0</span>, verbose_name=<span class="string">'商品来源店铺ID'</span>)  <span class="comment"># 订单内商品实际来源店铺的id，已废弃</span></div><div class="line">	buyer_name = models.CharField(max_length=<span class="number">100</span>)  <span class="comment"># 购买人姓名</span></div><div class="line"></div><div class="line"></div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">Product</span><span class="params">(models.Model)</span>:</span></div><div class="line">	owner = models.ForeignKey(User, related_name=<span class="string">'user-product'</span>)</div><div class="line">	name = models.CharField(max_length=<span class="number">256</span>)  <span class="comment"># 商品名称</span></div><div class="line">	physical_unit = models.CharField(default=<span class="string">''</span>, max_length=<span class="number">256</span>)  <span class="comment"># 计量单位</span></div><div class="line">	price = models.FloatField(default=<span class="number">0.0</span>)  <span class="comment"># 商品价格</span></div></pre></td></tr></table></figure>
<p>OrderHasProduct有外键Product和外键Order。</p>
<h3 id="4-1-外键赋值"><a href="#4-1-外键赋值" class="headerlink" title="4.1.外键赋值"></a>4.1.外键赋值</h3><figure class="highlight lasso"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">mall_models.OrderHasProduct.create(</div><div class="line">	<span class="keyword">order</span>=<span class="built_in">self</span>.db_model,</div><div class="line">	product=product.id,</div><div class="line">	<span class="params">...</span></div></pre></td></tr></table></figure>
<p>可以看到把<strong>外键实例</strong>或者<strong>外键实例的id</strong>都是可以的。</p>
<h3 id="4-2-涉及外键的查询"><a href="#4-2-涉及外键的查询" class="headerlink" title="4.2.涉及外键的查询"></a>4.2.涉及外键的查询</h3><h4 id="4-2-1-根据外键的主键查询"><a href="#4-2-1-根据外键的主键查询" class="headerlink" title="4.2.1 根据外键的主键查询"></a>4.2.1 根据外键的主键查询</h4><p>直接<code>OrderHasProduct.select().where(where(mall_models.Order.id=order.id).product_id=10086)</code></p>
<h4 id="4-2-2-根据外键的某字段查询（join外键）"><a href="#4-2-2-根据外键的某字段查询（join外键）" class="headerlink" title="4.2.2 根据外键的某字段查询（join外键）"></a>4.2.2 根据外键的某字段查询（join外键）</h4><figure class="highlight haskell"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line"><span class="class"><span class="keyword">class</span> <span class="type">Rule</span>(<span class="title">models</span>.<span class="type">Model</span>):</span></div><div class="line">	owner = models.<span class="type">ForeignKey</span>(<span class="type">User</span>)</div><div class="line">	name = models.<span class="type">CharField</span>(<span class="title">max_length</span>=20, <span class="title">db_index</span>=<span class="type">True</span>) </div><div class="line">	valid = models.<span class="type">DecimalField</span>(<span class="title">max_digits</span>=65) </div><div class="line"></div><div class="line"></div><div class="line"><span class="keyword">class</span> <span class="type">Card</span>(<span class="title">models</span>.<span class="type">Model</span>):</div><div class="line">	owner = models.<span class="type">ForeignKey</span>(<span class="type">User</span>)</div><div class="line">	rule = models.<span class="type">ForeignKey</span>(<span class="type">Rule</span>)</div></pre></td></tr></table></figure>
<p>Card有外键Rule。</p>
<figure class="highlight stylus"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">count = Card.select().join(wzcard_models.Rule).where(Card<span class="selector-class">.card_id</span><span class="selector-class">.in_</span>(ids),Rule<span class="selector-class">.valid</span> &gt;<span class="number">0</span>).count()</div></pre></td></tr></table></figure>
<p>的确很长，peewee不支持django风格的”__”（双下划线），所以就直街上join了，peewee默认使用INNER join。</p>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <link itemprop="mainEntityOfPage" href="http://ifchanged.io/2016/emoji、Python、MySQL utf8mb4与UTF/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="zeroten">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="IFchanged">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2016/emoji、Python、MySQL utf8mb4与UTF/" itemprop="url">
                  emoji、Python、MySQL utf8mb4与UTF
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2016-03-20T21:16:31+08:00">
                2016-03-20
              </time>
            

            

            
          </span>

          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2016/emoji、Python、MySQL utf8mb4与UTF/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count disqus-comment-count"
                        data-disqus-identifier="2016/emoji、Python、MySQL utf8mb4与UTF/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          

          

          

          

        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>编码、字符集是很大的内容，本文简单聊聊Python、MySQL中处理emoji这种特殊字符的问题。本文描述的Python是2.x版本，3.x情况可能有所不同</p>
<h2 id="问题描述"><a href="#问题描述" class="headerlink" title="问题描述"></a>问题描述</h2><p>如果向MySQL utf8的表中保存一个emoji字符，必然出错，因为emoji是4字节字符，而MySQL utf8只支持3字节字符。MySQL 5.5开始加入utf8mb4支持4字节字符，但是又带来了显示的问题，毕竟PC上无法正常显示emoji的，而且能显示的系统又各家有各家的样子。所以要么把emoji过滤掉、要么在显示时候做特殊处理。</p>
<h2 id="浅谈UTF"><a href="#浅谈UTF" class="headerlink" title="浅谈UTF"></a>浅谈UTF</h2><p>最常用的字符都在BMP（Basic Multilingual Plane, 基本多语言平面），范围是<strong>U+0000至U+FFFF</strong>。只有这些码位在UCS-2可用，也是MySQL UTF8可以存储的范围，其它字符存储在辅助平面。</p>
<p>其中从<strong>U+D800到U+DFFF</strong>之间的码位区段是永久保留不映射到Unicode字符。UTF-16就利用保留下来的0xD800-0xDFFF区段的码位来对辅助平面的字符的码位进行编码。Unicode规定这个范围不对应字符，但在使用UCS-2时会被用于映射某些字符。</p>
<h2 id="MySQL对4字节字符的支持"><a href="#MySQL对4字节字符的支持" class="headerlink" title="MySQL对4字节字符的支持"></a>MySQL对4字节字符的支持</h2><p>MySQL 5.5开始有了utf8mb4字符集，兼容utf8并且可以存储4字节字符，详见<a href="https://dev.mysql.com/doc/refman/5.5/en/charset-unicode-utf8mb4.html" target="_blank" rel="external">https://dev.mysql.com/doc/refman/5.5/en/charset-unicode-utf8mb4.html</a></p>
<h2 id="Python中的4字节字符"><a href="#Python中的4字节字符" class="headerlink" title="Python中的4字节字符"></a>Python中的4字节字符</h2><p>最开始的方案是直接识别4字节字符并直接过滤掉，3字节的范围是<code>\u0000-\uFFFF</code>，如果想直接判断一个字符是否在这个范围，<strong>可能</strong>会惊奇的发现一个字符被拆分成了两个字符，该字符的长度也是<strong>2</strong>。比如<code>\U0001f604</code>(笑脸表情，参见<a href="https://codepoints.net/U+1F604" target="_blank" rel="external">https://codepoints.net/U+1F604</a>)会被拆分成<code>\ud83d</code>和<code>\ude04</code>，<code>\U0001f604</code>展示了以一当二的能力。至于说可能，是因为这是由Python解释器编译时候编译选项是–enable-unicode=ucs4还是–enable-unicode=ucs2决定的，后者就是前文描述的情况。查看当前Python情况可以输出sys.maxunicode，得到65535就是ucs2，详见Python文档<a href="https://docs.python.org/2/library/sys.html#sys.maxunicode" target="_blank" rel="external">https://docs.python.org/2/library/sys.html#sys.maxunicode</a> 。ucs4下，4字节字符范围在<code>\U00010000-\U0010ffff</code>，usc2下拆分出的两个字符会在\uD800-\uDFFF范围。所以如果要过滤emoji或者其他特殊字符，可以根据此范围替换。</p>
<h2 id="代码示例"><a href="#代码示例" class="headerlink" title="代码示例"></a>代码示例</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">filter_invalid_str</span><span class="params">(text)</span>:</span></div><div class="line">	<span class="string">"""</span></div><div class="line">	过滤非BMP字符</div><div class="line">	"""</div><div class="line">	<span class="keyword">try</span>:</div><div class="line">		<span class="comment"># UCS-4</span></div><div class="line">		highpoints = re.compile(<span class="string">u'[\U00010000-\U0010ffff]'</span>)</div><div class="line">	<span class="keyword">except</span> re.error:</div><div class="line">		<span class="comment"># UCS-2</span></div><div class="line">		highpoints = re.compile(<span class="string">u'[\uD800-\uDBFF][\uDC00-\uDFFF]'</span>)</div><div class="line"></div><div class="line">	<span class="keyword">return</span> highpoints.sub(<span class="string">u'_'</span>, text)</div></pre></td></tr></table></figure>
<p>参考：</p>
<ul>
<li><a href="https://en.wikipedia.org/wiki/UTF-16" target="_blank" rel="external">https://en.wikipedia.org/wiki/UTF-16</a></li>
<li><a href="https://docs.python.org/2/library/sys.html#sys.maxunicode" target="_blank" rel="external">https://docs.python.org/2/library/sys.html#sys.maxunicode</a></li>
<li><a href="https://dev.mysql.com/doc/refman/5.5/en/charset-unicode-utf8mb4.html" target="_blank" rel="external">https://dev.mysql.com/doc/refman/5.5/en/charset-unicode-utf8mb4.html</a></li>
<li><a href="http://stackoverflow.com/questions/26568722/remove-unicode-emoji-using-re-in-python" target="_blank" rel="external">http://stackoverflow.com/questions/26568722/remove-unicode-emoji-using-re-in-python</a></li>
</ul>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <link itemprop="mainEntityOfPage" href="http://ifchanged.io/2015/git技巧/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="zeroten">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="IFchanged">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2015/git技巧/" itemprop="url">
                  git技巧
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2015-11-23T10:44:27+08:00">
                2015-11-23
              </time>
            

            

            
          </span>

          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2015/git技巧/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count disqus-comment-count"
                        data-disqus-identifier="2015/git技巧/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          

          

          

          

        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>git技巧，不断更新中</p>
<ol>
<li><p>查找分支某个commit: </p>
<ol>
<li><code>git log|grep commitID</code></li>
<li><code>git branch --contains commitID</code> 可以配合grep指定分支</li>
</ol>
</li>
<li><p>比较分支不同的commit<br> <code>git rev-list A ^B</code>查找在B但不在A分支的commit</p>
</li>
<li><p>查找分支开发起点<br> <code>git rev-list A ^B|tail -1</code> B分支从A分支checkout出后的开发起点</p>
</li>
<li><p>查找不同commit数<br> <code>git rev-list A ^B --conut</code></p>
</li>
<li><p>强制更新本地分支到远程状态</p>
<figure class="highlight maxima"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">git fetch</div><div class="line">git <span class="built_in">reset</span> --hard <span class="built_in">origin</span>/master</div></pre></td></tr></table></figure>
</li>
</ol>
<p>或<br><figure class="highlight crmsh"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">git fetch</div><div class="line">git checkout origin/<span class="keyword">master</span> <span class="title">-B</span> <span class="literal">master</span></div></pre></td></tr></table></figure></p>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="http://schema.org/Article">
    <link itemprop="mainEntityOfPage" href="http://ifchanged.io/2015/git笔记-撤销与回滚/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="name" content="zeroten">
      <meta itemprop="description" content="">
      <meta itemprop="image" content="/images/avatar.gif">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="IFchanged">
    </span>

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2015/git笔记-撤销与回滚/" itemprop="url">
                  git笔记-撤销与回滚
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              
                <span class="post-meta-item-text">发表于</span>
              
              <time title="创建于" itemprop="dateCreated datePublished" datetime="2015-11-19T11:31:25+08:00">
                2015-11-19
              </time>
            

            

            
          </span>

          

          
            
              <span class="post-comments-count">
                <span class="post-meta-divider">|</span>
                <span class="post-meta-item-icon">
                  <i class="fa fa-comment-o"></i>
                </span>
                <a href="/2015/git笔记-撤销与回滚/#comments" itemprop="discussionUrl">
                  <span class="post-comments-count disqus-comment-count"
                        data-disqus-identifier="2015/git笔记-撤销与回滚/" itemprop="commentCount"></span>
                </a>
              </span>
            
          

          
          

          

          

          

        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="1-撤销"><a href="#1-撤销" class="headerlink" title="1.撤销"></a>1.撤销</h2><h3 id="撤销文件修改"><a href="#撤销文件修改" class="headerlink" title="撤销文件修改"></a>撤销文件修改</h3><p>checkout以文件作为参数时会<strong>修改</strong>文件为指定版本的状态。</p>
<ul>
<li>撤销未暂存的文件：<code>git checkout hello.py</code>，<code>git checkout .</code>为所有未暂存文件</li>
<li>撤销未commit的文件：<code>git checkout HEAD hello.py</code></li>
<li>撤销已经commit的文件到指定版本，如e316e21：<figure class="highlight stylus"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">git checkout e316e21 t1<span class="selector-class">.txt</span></div><div class="line">git add t1<span class="selector-class">.txt</span></div><div class="line">git commit -m <span class="string">'恢复t1.txt到e316e21'</span></div></pre></td></tr></table></figure>
</li>
</ul>
<p><strong>注</strong>：以上撤销不会改写commit记录</p>
<h3 id="1-1-撤销commit（不改写commit记录）"><a href="#1-1-撤销commit（不改写commit记录）" class="headerlink" title="1.1 撤销commit（不改写commit记录）"></a>1.1 撤销commit（不改写commit记录）</h3><p>revert命令用新的commit来撤销修改，不改写提交记录。</p>
<ul>
<li>revert指定commit:<code>git revert e316e21</code></li>
<li><p>revert多个commit:<br>下文的大写字母带走commitID<br>方案1： 撤销多个commit并生成多个revert commit:<code>git revert A B C</code><br>方案2：撤销多个commit并生成一个revert commit：</p>
<figure class="highlight nginx"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"><span class="attribute">git</span> revert A B C --<span class="literal">no</span>-commit</div><div class="line">git commit -m <span class="string">'the commit message'</span></div></pre></td></tr></table></figure>
</li>
<li><p>revert指定范围：<code>git revert A..D</code></p>
</li>
</ul>
<h3 id="1-2-撤销commit（改写commit记录）"><a href="#1-2-撤销commit（改写commit记录）" class="headerlink" title="1.2 撤销commit（改写commit记录）"></a>1.2 撤销commit（改写commit记录）</h3><p>使用reset或者rebase可以改写记录，但是要注意的是一旦改写，commit将会消失，并且会和远程分支、他人的本地分支冲突，push时需要用参数<code>-f</code>强制提交。所以，除非你清楚的知道重写的作用以及对他人带来的影响，不要轻易重写记录。</p>
<h4 id="rebase"><a href="#rebase" class="headerlink" title="rebase"></a>rebase</h4><p><code>git rebase -i commitID</code> commitID只要撤销的commit之前的一个或者某个commit<br><figure class="highlight vala"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div></pre></td><td class="code"><pre><div class="line">pick a5997c9 <span class="number">1</span></div><div class="line">pick <span class="number">88</span>a1edf <span class="number">2</span></div><div class="line">pick dfa8d09 <span class="number">3</span></div><div class="line">pick <span class="number">57</span>d2c26 <span class="number">4</span></div><div class="line">pick ff3451d <span class="number">5</span></div><div class="line"></div><div class="line"></div><div class="line"><span class="meta"># Rebase dfa8d09..ff3451d onto dfa8d09 (2 command(s))</span></div><div class="line"><span class="meta">#</span></div><div class="line"><span class="meta"># Commands:</span></div><div class="line"><span class="meta"># p, pick = use commit</span></div><div class="line"><span class="meta"># r, reword = use commit, but edit the commit message</span></div><div class="line"><span class="meta"># e, edit = use commit, but stop for amending</span></div><div class="line"><span class="meta"># s, squash = use commit, but meld into previous commit</span></div><div class="line"><span class="meta"># f, fixup = like "squash", but discard this commit's log message</span></div><div class="line"><span class="meta"># x, exec = run command (the rest of the line) using shell</span></div><div class="line"><span class="meta"># d, drop = remove commit</span></div><div class="line"><span class="meta">#</span></div><div class="line"><span class="meta"># These lines can be re-ordered; they are executed from top to bottom.</span></div><div class="line"><span class="meta">#</span></div><div class="line"><span class="meta"># If you remove a line here THAT COMMIT WILL BE LOST.</span></div><div class="line"><span class="meta">#</span></div><div class="line"><span class="meta"># However, if you remove everything, the rebase will be aborted.</span></div><div class="line"><span class="meta">#</span></div><div class="line"><span class="meta"># Note that empty commits are commented out</span></div></pre></td></tr></table></figure></p>
<p>参照git的提示，把要撤销的commit的action改为d，或者把正行删掉。</p>
<h4 id="reset"><a href="#reset" class="headerlink" title="reset"></a>reset</h4><p>如果这是要回滚到某个指定版本，如A，则直接<code>git reset A --hard</code>，如果要撤销的是提交记录中间的一个，则需要配合stash命令使用。<br>如有以下提交，要撤销其中的D提交，则：<br><figure class="highlight mathematica"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">A</div><div class="line">B</div><div class="line"><span class="keyword">C</span></div><div class="line"><span class="keyword">D</span></div><div class="line"><span class="keyword">E</span></div></pre></td></tr></table></figure></p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">git <span class="keyword">reset</span> <span class="comment">--soft D</span></div><div class="line">git stash</div><div class="line">git <span class="keyword">reset</span> <span class="comment">--hard E</span></div><div class="line">git stash pop</div><div class="line">git <span class="keyword">commit</span> -am 撤销D</div></pre></td></tr></table></figure>
<h3 id="1-3-撤销add"><a href="#1-3-撤销add" class="headerlink" title="1.3 撤销add"></a>1.3 撤销add</h3><p>当把某个文件add后，可以使用<code>git reset file_path</code>撤销add。</p>
<h3 id="1-4-撤销最近一次commit"><a href="#1-4-撤销最近一次commit" class="headerlink" title="1.4 撤销最近一次commit"></a>1.4 撤销最近一次commit</h3><p>有时候我们提交完了才发现漏掉了几个文件没有添加，或者提交信息写错了。 此时，可以运行带有 –amend 选项的提交命令尝试重新提交：<br><figure class="highlight sql"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">$ git <span class="keyword">commit</span> -m <span class="string">'initial commit'</span></div><div class="line">$ git <span class="keyword">add</span> forgotten_file</div><div class="line">$ git <span class="keyword">commit</span> <span class="comment">--amend</span></div></pre></td></tr></table></figure></p>
<p>第二次提交将会覆盖之前的提交。</p>
<h3 id="撤销（删除）未追踪的文件"><a href="#撤销（删除）未追踪的文件" class="headerlink" title="撤销（删除）未追踪的文件"></a>撤销（删除）未追踪的文件</h3><p><code>git clean -fdx</code></p>
<h2 id="2-版本回滚"><a href="#2-版本回滚" class="headerlink" title="2.版本回滚"></a>2.版本回滚</h2><p>版本回滚指把当前的分支切换到某个指定版本，具体而言是切换到某个commit或者tag，和上文提到的撤销类似，当从head开始撤销连续的若干commit就可达到回滚的效果。版本回滚是分支的角度，撤销是某个文件或者commit的角度。</p>
<p>如有以下提交，：<br><figure class="highlight mathematica"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">A</div><div class="line">B</div><div class="line"><span class="keyword">C</span></div><div class="line"><span class="keyword">D</span></div><div class="line"><span class="keyword">E</span></div></pre></td></tr></table></figure></p>
<p>要回滚<strong>到D</strong>提交，有以下方法。</p>
<h3 id="2-1-revert回滚（不改写commit记录）"><a href="#2-1-revert回滚（不改写commit记录）" class="headerlink" title="2.1 revert回滚（不改写commit记录）"></a>2.1 revert回滚（不改写commit记录）</h3><p>revert回滚是唯一可以不修改commit记录的回滚方式，但是会产生一次revert commit。方法是上文讲到的<strong>revert多个commit</strong>。此时，要把D之后的提交全部revert。则：<br><figure class="highlight gams"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="title">git</span></span> revert D..HEAD --<span class="keyword">no</span>-commit</div><div class="line">git commit -am <span class="string">'revert to D'</span></div></pre></td></tr></table></figure></p>
<p>当不清楚范围是否制定正确的时候，可以使用<code>git revert D..HEAD</code>，与上面命令的区别是没有–no-commit参数，也不用最好再commit，git会自动的revert每一个commit并每个commit生成一个revert commit，这样就能看到revert了哪些commit。</p>
<h3 id="2-2-reset回滚（改写commit记录）"><a href="#2-2-reset回滚（改写commit记录）" class="headerlink" title="2.2 reset回滚（改写commit记录）"></a>2.2 reset回滚（改写commit记录）</h3><p>和撤销中的用法类似：<br><figure class="highlight sql"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">git <span class="keyword">reset</span> <span class="comment">--hard D</span></div></pre></td></tr></table></figure></p>
<h3 id="2-2-checkout回滚（改写提交记录）"><a href="#2-2-checkout回滚（改写提交记录）" class="headerlink" title="2.2 checkout回滚（改写提交记录）"></a>2.2 checkout回滚（改写提交记录）</h3><p>checkout有三个目标，checkout文件是撤销中提到的改写文件，checkout分支是常用的切换分支，checkout commit就会切换到该commit，结合切换分支就可以达到回滚分支的作用。<br><figure class="highlight ebnf"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="attribute">git checkout D</span></div></pre></td></tr></table></figure></p>
<p>此时git会给出提示:</p>
<blockquote>
<p>You are in ‘detached HEAD’ state. You can look around, make experimental<br>changes and commit them, and you can discard any commits you make in this<br>state without impacting any branches by performing another checkout.</p>
</blockquote>
<p>简而言之，我们现在不在分支上，在’detached HEAD’ state（游离状态），当前的代码在commit D发生时的状态，<strong>此时的任何更改不会影响到任何分支</strong>。我们可以不回滚代码就可让代码处于之前的某个提交，查看之前的代码或者做些实验。</p>
<p>从游离状态退出的方法是checkout到某个分支，你如<code>git checkout master</code>。而如果用创建分支的方法checkout -b <branch_name>就可以从当前创建分支，结合强制创建分支的参数-B，checkout回滚分支可以概括为：<br><figure class="highlight armasm"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="symbol">git</span> checkout -<span class="keyword">B </span>test <span class="number">6</span>a26980</div></pre></td></tr></table></figure></branch_name></p>
<p>其中test是当前的分支名，6a26980是要回滚到的版本。</p>
<h3 id="2-3-本地分支回滚到远程分支"><a href="#2-3-本地分支回滚到远程分支" class="headerlink" title="2.3 本地分支回滚到远程分支"></a>2.3 本地分支回滚到远程分支</h3><p>当本地分支被改的乱七八糟时，你可能会想到重新拉取远程分支，一切重来。比较容易理解的方式可能是：<br><figure class="highlight bash"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">git checkout -B master 随便切换个别的分支</div><div class="line">git branch -D <span class="built_in">test</span> 把糟糕的本地分支删掉</div><div class="line">git fetch 更新下远程引用分支</div><div class="line">git checkout <span class="built_in">test</span> 重新checkout <span class="built_in">test</span>分支</div></pre></td></tr></table></figure></p>
<p>这样子非常繁琐。有两个便捷的命令：<br><code>git checkout origin/test -B test</code>或者<code>git reset origin/test --hard</code>,当然，执行前别忘了<code>git fetch</code>更新。</p>
<h2 id="3-reflog"><a href="#3-reflog" class="headerlink" title="3.reflog"></a>3.reflog</h2><p>reflog记录了<strong>本地仓库</strong>的指针移动,使用<code>git reflog</code>查看,<code>git reflog --relative-date</code>可以查看到时间。，如下：<br><figure class="highlight groovy"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">b37132b HEAD@&#123;<span class="number">16</span> minutes ago&#125;: <span class="string">reset:</span> moving to origin/master</div><div class="line"><span class="number">94</span>a99ad HEAD@&#123;<span class="number">16</span> minutes ago&#125;: <span class="string">commit:</span> s</div><div class="line">b37132b HEAD@&#123;<span class="number">21</span> minutes ago&#125;: <span class="string">clone:</span> from git<span class="meta">@github</span>.<span class="string">com:</span>ladder1984/updateHosts</div></pre></td></tr></table></figure></p>
<p>上面的日志显示进行了reset操作，如果想恢复到reset之前的状态，可以使用<code>git reset 94a99ad --hard</code>命令。注意，reflog查看到的ID也是可以checkout命令的，所以也可以使用<code>git checkout 94a99ad -B master</code></p>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
  </section>

  
  <nav class="pagination">
    <span class="page-number current">1</span><a class="page-number" href="/page/2/">2</a><span class="space">&hellip;</span><a class="page-number" href="/page/9/">9</a><a class="extend next" rel="next" href="/page/2/"><i class="fa fa-angle-right"></i></a>
  </nav>



          </div>
          


          

        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    <div class="sidebar-inner">

      

      

      <section class="site-overview sidebar-panel sidebar-panel-active">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
          <img class="site-author-image" itemprop="image"
               src="/images/avatar.gif"
               alt="zeroten" />
          <p class="site-author-name" itemprop="name">zeroten</p>
           
              <p class="site-description motion-element" itemprop="description"></p>
          
        </div>
        <nav class="site-state motion-element">

          
            <div class="site-state-item site-state-posts">
              <a href="/archives">
                <span class="site-state-item-count">86</span>
                <span class="site-state-item-name">日志</span>
              </a>
            </div>
          

          
            
            
            <div class="site-state-item site-state-categories">
              <a href="/categories/index.html">
                <span class="site-state-item-count">10</span>
                <span class="site-state-item-name">分类</span>
              </a>
            </div>
          

          
            
            
            <div class="site-state-item site-state-tags">
              
                <span class="site-state-item-count">42</span>
                <span class="site-state-item-name">标签</span>
              
            </div>
          

        </nav>

        
          <div class="feed-link motion-element">
            <a href="/atom.xml" rel="alternate">
              <i class="fa fa-rss"></i>
              RSS
            </a>
          </div>
        

        <div class="links-of-author motion-element">
          
            
              <span class="links-of-author-item">
                <a href="https://github.com/ladder1984" target="_blank" title="GitHub">
                  
                    <i class="fa fa-fw fa-github"></i>
                  
                  GitHub
                </a>
              </span>
            
          
        </div>

        
        

        
        

        


      </section>

      

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright" >
  
  &copy; 
  <span itemprop="copyrightYear">2017</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">zeroten</span>
</div>


<div class="powered-by">
  由 <a class="theme-link" href="https://hexo.io">Hexo</a> 强力驱动
</div>

<div class="theme-info">
  主题 -
  <a class="theme-link" href="https://github.com/iissnan/hexo-theme-next">
    NexT.Muse
  </a>
</div>


        

        
      </div>
    </footer>

    
      <div class="back-to-top">
        <i class="fa fa-arrow-up"></i>
        
      </div>
    

  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  






  
  <script type="text/javascript" src="/lib/jquery/index.js?v=2.1.3"></script>

  
  <script type="text/javascript" src="/lib/fastclick/lib/fastclick.min.js?v=1.0.6"></script>

  
  <script type="text/javascript" src="/lib/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>

  
  <script type="text/javascript" src="/lib/velocity/velocity.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/lib/velocity/velocity.ui.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/lib/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.1.0"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.1.0"></script>



  
  

  

  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.1.0"></script>



  


  

    
      <script id="dsq-count-scr" src="https://ifchanged.disqus.com/count.js" async></script>
    

    

  













  





  

  

  

  

</body>
</html>
